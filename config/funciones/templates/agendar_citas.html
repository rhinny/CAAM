{% extends "index.html" %}
{% block content %}
<div class="container mt-4">
    <h2>Estás agendando una cita con:</h2>
    <div class="card mt-4 tu-perfil">
        <h1 class="card-title"><b>{{ estudiante.first_name }} {{ estudiante.last_name }}</b></h1>

        {% if publi %}
            <div class="card mt-3">
                <div class="card-body">
                    <div class="card-header"> <strong>Descripción:</strong> {{ publi.descripcion }}</div>
                    <br>
                </div>
            </div>
        {% endif %}

        <div class="card mt-3">
            <div class="card-header"><strong>Áreas:</strong></div>
            <div class="card-body">
                <ul class="list-group">
                    {% for area in estudiante.areas.all %}
                        <li class="list-group-item">{{ area.nombre }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header"> <strong>Comuna:</strong> {{ estudiante.comuna.nombre }}</div>
        </div>
        <br>
        <div class="card mt-3">
            <div class="card-header"><strong>Campus Universitario:</strong> {{ estudiante.get_campus_display }}</div>
        </div>
    </div>

<!-- Selección de fechas -->
<div class="container mt-4">
    <h2>Agendar cita</h2>

    <!-- Calendario -->
    <div id="calendar"></div>

    <!-- Formulario oculto para confirmar -->
    <form method="post" class="mt-4">
        {% csrf_token %}
        <input type="hidden" name="fecha_id" id="fecha_id">
        <button type="submit" class="btn btn-success" id="confirmar-btn" disabled>Confirmar cita</button>
    </form>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const fechaInput = document.getElementById('fecha_id');
    const confirmarBtn = document.getElementById('confirmar-btn');

    let eventoSeleccionado = null

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: ''
        },
        events: [
            {% for fecha in fechas %}
            {
                {% if fecha.disponible %}
                title: 'Disponible',
                start: '{{ fecha.fecha|date:"Y-m-d" }}',
                id: '{{ fecha.id }}',
                    backgroundColor: 'green',
                //{% else %}
                //title: 'No Disponible',
                //start: '{{ fecha.fecha|date:"Y-m-d" }}',
                //id: '{{ fecha.id }}',
                    //backgroundColor: "#d50c34",
                {% endif %}
            },
            {% endfor %}
        ],
        eventClick: function(info) {
            if(eventoSeleccionado){
                eventoSeleccionado.setProp('backgroundColor','green')
                eventoSeleccionado.setProp('title','Disponible')
            }

            eventoSeleccionado = info.event;
            info.event.setProp('backgroundColor','darkblue') 
            info.event.setProp('title','Agendado') 
            fechaInput.value = info.event.id;
            confirmarBtn.disabled = false;
        }
    });

    calendar.render();
});
</script>

<div class="mt-4">
        <a href="{% url 'elegir' %}" class="btn btn-button">Volver al listado</a>
</div>
{% endblock %}
<!-- info.event.setProp('backgroundColor','e42f47') debería cambiar el evento a rojouna vez seleccionado. -->